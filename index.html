<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Batik Matika - Game Edukasi Numerasi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Serif:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles & Touch Optimization */
        body { 
            font-family: 'Noto Sans', sans-serif; 
            touch-action: manipulation;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
        .font-serif { font-family: 'Noto Serif', serif; }
        .font-script { font-family: 'Pinyon Script', cursive; }
        
        /* Animations */
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-spin-slow { animation: spin 10s linear infinite; }
        
        @keyframes boom {
            0% { transform: scale(0.5); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }
        .explosion-effect { animation: boom 0.4s ease-out forwards; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .puzzle-piece {
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
        }
        
        /* Utility for Mobile Height */
        .min-h-dvh { min-height: 100dvh; }
        .h-dvh { height: 100dvh; }
        
        #error-container { display: none; padding: 20px; background: #fee2e2; color: #991b1b; border: 1px solid #f87171; margin: 20px; border-radius: 8px; font-family: monospace; }
    </style>
</head>
<body class="bg-slate-900 text-slate-800 select-none">
    <div id="error-container"></div>
    <div id="root"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            // Ignore benign resize loop error
            if (message && message.includes("ResizeObserver loop")) return;
            
            const container = document.getElementById('error-container');
            container.style.display = 'block';
            container.innerHTML = `<strong>Error Terdeteksi:</strong><br>${message}<br><small>${source}:${lineno}</small>`;
            console.error("Global Error:", error);
        };
    </script>

    <!-- React & Firebase via ES Modules -->
    <script type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken,
            signOut 
        } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            onSnapshot, 
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        // ==========================================
        // 1. DATA & KONSTANTA (DEFINISI DI AWAL)
        // ==========================================

        const PROVINCES = [
            "Semua Provinsi", "Aceh", "Sumatera Utara", "Sumatera Barat", "Riau", "Jambi", 
            "Sumatera Selatan", "Bengkulu", "Lampung", "DKI Jakarta", "Jawa Barat", 
            "Jawa Tengah", "DI Yogyakarta", "Jawa Timur", "Banten", "Bali", 
            "Nusa Tenggara Barat", "Nusa Tenggara Timur", "Kalimantan Barat", 
            "Kalimantan Tengah", "Kalimantan Selatan", "Kalimantan Timur", 
            "Kalimantan Utara", "Sulawesi Utara", "Sulawesi Tengah", "Sulawesi Selatan", 
            "Sulawesi Tenggara", "Gorontalo", "Sulawesi Barat", "Maluku", 
            "Maluku Utara", "Papua Barat", "Papua"
        ];

        const BATIKS = [
            { id: 'kawung', name: 'Kawung', price: 0, mathConcept: 'Geometri: Interseksi Lingkaran', pattern: 'circles', baseScore: 100, penalty: 0, ruleDesc: "Benar: 100 (Spesial 200). Salah: -0." },
            { id: 'megamendung', name: 'Megamendung', price: 2500, mathConcept: 'Fraktal: Kurva & Skala Berulang', pattern: 'clouds', baseScore: 150, penalty: 100, ruleDesc: "Benar: 150 (Spesial 300). Salah: -100." },
            { id: 'parang', name: 'Parang Rusak', price: 5000, mathConcept: 'Geometri: Garis Sejajar & Kemiringan', pattern: 'diagonal', baseScore: 200, penalty: 150, ruleDesc: "Benar: 200 (Spesial 400). Salah: -150." },
            { id: 'truntum', name: 'Truntum', price: 10000, mathConcept: 'Geometri: Pola Bintang & Sudut Pusat', pattern: 'stars', baseScore: 500, penalty: 300, ruleDesc: "Benar: 500 (Spesial 1000). Salah: -300." },
        ];

        const RANKS = [
            { min: 0, title: "Pemula Batik", color: "text-slate-600" },
            { min: 1000, title: "Pengrajin Muda", color: "text-green-600" },
            { min: 5000, title: "Ahli Canting", color: "text-blue-600" },
            { min: 10000, title: "Maestro Batik", color: "text-purple-600" },
            { min: 25000, title: "Legenda Nusantara", color: "text-amber-500" },
        ];

        const MAX_LEVEL_TO_WIN = 3; 

        // ==========================================
        // 2. KONFIGURASI (FIREBASE & APPS SCRIPT)
        // ==========================================

        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwEwGfKCqaFEUphLjCc6zGYKX0yBXEX56IeP7yHb1ZPD2VsU_P0ML6Hb6xMjdGBiQGtgg/exec"; 

        // ⚠️ PASTIKAN BAGIAN INI DIISI DENGAN DATA DARI FIREBASE CONSOLE ANDA
        let firebaseConfig = {
            apiKey: "ISI_API_KEY_ANDA_DISINI",
            authDomain: "ISI_PROJECT_ID_ANDA.firebaseapp.com",
            projectId: "ISI_PROJECT_ID_ANDA",
            storageBucket: "ISI_PROJECT_ID_ANDA.appspot.com",
            messagingSenderId: "ISI_MESSAGING_ID",
            appId: "ISI_APP_ID"
        };

        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch(e) {
                console.log("Menggunakan config manual/default");
            }
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'batik-matika-html';
        
        let app, auth, db;
        let firebaseInitError = null;

        try {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "ISI_API_KEY_ANDA_DISINI") {
                throw new Error("Konfigurasi Firebase belum diisi! Silakan edit file index.html dan isi firebaseConfig dengan data dari Firebase Console.");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) {
            console.error("Firebase Init Error", e);
            firebaseInitError = e.message;
        }

        // ==========================================
        // 3. ICON COMPONENTS
        // ==========================================
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            React.createElement('svg', { 
                xmlns: "http://www.w3.org/2000/svg", 
                width: size, 
                height: size, 
                viewBox: "0 0 24 24", 
                fill: "none", 
                stroke: "currentColor", 
                strokeWidth: "2", 
                strokeLinecap: "round", 
                strokeLinejoin: "round", 
                className: className, 
                ...props 
            }, children)
        );

        const Play = (props) => React.createElement(IconBase, props, React.createElement('polygon', { points: "5 3 19 12 5 21 5 3" }));
        const Users = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" }),
            React.createElement('circle', { key: 'c1', cx: "9", cy: "7", r: "4" }),
            React.createElement('path', { key: 'p2', d: "M23 21v-2a4 4 0 0 0-3-3.87" }),
            React.createElement('path', { key: 'p3', d: "M16 3.13a4 4 0 0 1 0 7.75" })
        ]);
        const ShoppingBag = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" }),
            React.createElement('path', { key: 'p2', d: "M3 6h18" }),
            React.createElement('path', { key: 'p3', d: "M16 10a4 4 0 0 1-8 0" })
        ]);
        const Trophy = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "M6 9H4.5a2.5 2.5 0 0 1 0-5H6" }),
            React.createElement('path', { key: 'p2', d: "M18 9h1.5a2.5 2.5 0 0 0 0-5H18" }),
            React.createElement('path', { key: 'p3', d: "M4 22h16" }),
            React.createElement('path', { key: 'p4', d: "M8 22v-4.17" }),
            React.createElement('path', { key: 'p5', d: "M16 22v-4.17" }),
            React.createElement('path', { key: 'p6', d: "M12 2a5 5 0 0 0-5 5v2a5 5 0 0 0 5 5 5 5 0 0 0 5-5V7a5 5 0 0 0-5-5Z" })
        ]);
        const ArrowLeft = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "m12 19-7-7 7-7" }),
            React.createElement('path', { key: 'p2', d: "M19 12H5" })
        ]);
        const Zap = (props) => React.createElement(IconBase, props, React.createElement('polygon', { points: "13 2 3 14 12 14 11 22 21 10 12 10 13 2" }));
        const Lock = (props) => React.createElement(IconBase, props, [
            React.createElement('rect', { key: 'r1', x: "3", y: "11", width: "18", height: "11", rx: "2", ry: "2" }),
            React.createElement('path', { key: 'p1', d: "M7 11V7a5 5 0 0 1 10 0v4" })
        ]);
        const CheckCircle = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "M22 11.08V12a10 10 0 1 1-5.93-9.14" }),
            React.createElement('polyline', { key: 'p2', points: "22 4 12 14.01 9 11.01" })
        ]);
        const XCircle = (props) => React.createElement(IconBase, props, [
            React.createElement('circle', { key: 'c1', cx: "12", cy: "12", r: "10" }),
            React.createElement('line', { key: 'l1', x1: "15", y1: "9", x2: "9", y2: "15" }),
            React.createElement('line', { key: 'l2', x1: "9", y1: "9", x2: "15", y2: "15" })
        ]);
        const School = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "m4 6 8-4 8 4" }),
            React.createElement('path', { key: 'p2', d: "m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2" }),
            React.createElement('path', { key: 'p3', d: "M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4" }),
            React.createElement('path', { key: 'p4', d: "M18 5v17" }),
            React.createElement('path', { key: 'p5', d: "M6 5v17" }),
            React.createElement('circle', { key: 'c1', cx: "12", cy: "9", r: "2" })
        ]);
        const MapPin = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0Z" }),
            React.createElement('circle', { key: 'c1', cx: "12", cy: "10", r: "3" })
        ]);
        const User = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" }),
            React.createElement('circle', { key: 'c1', cx: "12", cy: "7", r: "4" })
        ]);
        const Heart = (props) => React.createElement(IconBase, props, React.createElement('path', { d: "M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" }));
        const RefreshCw = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" }),
            React.createElement('path', { key: 'p2', d: "M21 3v5h-5" }),
            React.createElement('path', { key: 'p3', d: "M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" }),
            React.createElement('path', { key: 'p4', d: "M8 16H3v5" })
        ]);
        const AlertTriangle = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" }),
            React.createElement('line', { key: 'l1', x1: "12", y1: "9", x2: "12", y2: "13" }),
            React.createElement('line', { key: 'l2', x1: "12", y1: "17", x2: "12.01", y2: "17" })
        ]);
        const Filter = (props) => React.createElement(IconBase, props, [
            React.createElement('polygon', { key: 'p1', points: "22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" })
        ]);
        const Clock = (props) => React.createElement(IconBase, props, [
            React.createElement('circle', { key: 'c1', cx: "12", cy: "12", r: "10" }),
            React.createElement('polyline', { key: 'p1', points: "12 6 12 12 16 14" })
        ]);
        const LogOut = (props) => React.createElement(IconBase, props, [
            React.createElement('path', { key: 'p1', d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }),
            React.createElement('polyline', { key: 'p2', points: "16 17 21 12 16 7" }),
            React.createElement('line', { key: 'l1', x1: "21", y1: "12", x2: "9", y2: "12" })
        ]);


        // ==========================================
        // 4. HELPER & GAME COMPONENTS
        // ==========================================

        const playExplosionSound = () => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1500, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1500, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.01); 
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8); 
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.8);
            } catch (e) { console.error(e); }
        };

        const playWrongSound = () => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } catch (e) { console.error(e); }
        };

        const BatikPattern = ({ type, className, style }) => {
            let bg = {};
            if (type === 'circles') bg = { backgroundImage: 'radial-gradient(circle at 50% 50%, transparent 55%, #8b4513 56%, #8b4513 60%, transparent 61%), radial-gradient(circle at 0% 0%, transparent 55%, #8b4513 56%, #8b4513 60%, transparent 61%), radial-gradient(circle at 100% 0%, transparent 55%, #8b4513 56%, #8b4513 60%, transparent 61%), radial-gradient(circle at 100% 100%, transparent 55%, #8b4513 56%, #8b4513 60%, transparent 61%), radial-gradient(circle at 0% 100%, transparent 55%, #8b4513 56%, #8b4513 60%, transparent 61%)', backgroundSize: '40px 40px' };
            else if (type === 'clouds') bg = { backgroundImage: 'radial-gradient(ellipse at 50% 0%, #1e3a8a 20%, transparent 20%), radial-gradient(ellipse at 50% 10%, #1d4ed8 30%, transparent 30%), radial-gradient(ellipse at 50% 20%, #3b82f6 40%, transparent 40%)', backgroundSize: '60px 40px' };
            else if (type === 'diagonal') bg = { backgroundImage: 'repeating-linear-gradient(45deg, #44403c 0, #44403c 2px, transparent 2px, transparent 15px)', backgroundSize: '30px 30px' };
            else bg = { backgroundImage: 'conic-gradient(from 0deg at 50% 50%, #be123c 10deg, transparent 10deg, transparent 80deg, #be123c 80deg, #be123c 100deg, transparent 100deg, transparent 170deg, #be123c 170deg, #be123c 190deg, transparent 190deg, transparent 260deg, #be123c 260deg, #be123c 280deg, transparent 280deg, transparent 350deg, #be123c 350deg)', backgroundSize: '30px 30px' };
            return React.createElement('div', { className: `w-full h-full ${className} bg-amber-100 opacity-90`, style: { ...bg, ...style } });
        };

        const NumPad = ({ onInput, onDelete, onSubmit, disabled }) => React.createElement('div', { className: "grid grid-cols-3 gap-1 w-full max-w-[200px] md:max-w-[250px] mx-auto mt-2" },
            [1, 2, 3, 4, 5, 6, 7, 8, 9, 0].map(n => React.createElement('button', { key: n, disabled: disabled, onClick: () => onInput(n.toString()), className: "p-3 md:p-4 bg-white border-b-2 border-slate-300 rounded text-slate-800 font-bold active:bg-slate-100 disabled:opacity-50 text-xl md:text-2xl shadow-sm touch-manipulation" }, n)),
            React.createElement('button', { disabled: disabled, onClick: () => onDelete(), className: "p-3 md:p-4 bg-red-100 border-b-2 border-red-300 rounded text-red-800 font-bold text-sm md:text-base flex items-center justify-center shadow-sm touch-manipulation" }, "DEL"),
            React.createElement('button', { disabled: disabled, onClick: onSubmit, className: "p-3 md:p-4 bg-green-500 border-b-2 border-green-700 rounded text-white font-bold text-sm md:text-base flex items-center justify-center shadow-sm active:bg-green-600 touch-manipulation" }, "OK")
        );

        const Explosion = () => React.createElement('div', { className: "absolute inset-0 flex items-center justify-center z-50 pointer-events-none" }, React.createElement('div', { className: "w-full h-full bg-yellow-400 rounded-full explosion-effect absolute" }), React.createElement('div', { className: "w-3/4 h-3/4 bg-red-500 rounded-full explosion-effect delay-75 absolute" }));

        const PuzzleBlock = ({ block, batikType, onClick, totalRows = 4, totalCols = 5, isExploding }) => {
            const col = block.id % totalCols; const row = Math.floor(block.id / totalCols);
            let bgClass = block.isSpecial ? 'bg-gradient-to-br from-blue-500 to-blue-700' : 'bg-gradient-to-br from-amber-600 to-amber-800';
            return React.createElement('div', { onClick: onClick, className: `relative rounded-md overflow-hidden transition-all duration-300 transform ${block.active ? 'cursor-pointer hover:brightness-110 active:scale-95' : 'puzzle-piece'}`, style: { aspectRatio: '1/1' } },
                React.createElement('div', { className: "absolute inset-0" }, !block.active && React.createElement('div', { className: "w-full h-full relative overflow-hidden animate-pop" }, React.createElement('div', { className: "absolute", style: { width: `${totalCols * 100}%`, height: `${totalRows * 100}%`, left: `-${col * 100}%`, top: `-${row * 100}%` } }, React.createElement(BatikPattern, { type: batikType })))),
                block.active && React.createElement('div', { className: `absolute inset-0 ${bgClass} shadow-[inset_0_0_0_2px_rgba(255,255,255,0.1)] flex items-center justify-center z-10` }, React.createElement('span', { className: "text-white opacity-50 text-xs md:text-sm font-bold" }, block.isSpecial ? "★" : "?")),
                isExploding && React.createElement(Explosion)
            );
        };

        // ==========================================
        // 5. MAIN APP COMPONENT
        // ==========================================
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [view, setView] = useState('loading');
            const [authError, setAuthError] = useState(null);
            
            const [activeBatik, setActiveBatik] = useState(BATIKS[0]);
            const [level, setLevel] = useState(1);
            const [grid, setGrid] = useState([]);
            const [score, setScore] = useState(0);
            const [moves, setMoves] = useState(20);
            const [lives, setLives] = useState(5);
            const [isGameOver, setIsGameOver] = useState(false);
            const [selectedBlock, setSelectedBlock] = useState(null);
            const [question, setQuestion] = useState(null);
            const [inputAnswer, setInputAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [powerups, setPowerups] = useState({ bomb: 1, hint: 3 });
            const [explodingBlockId, setExplodingBlockId] = useState(null); 
            const [mpSetup, setMpSetup] = useState({ p1Name: '', p2Name: '', level: 1, p1Skin: 'kawung', p2Skin: 'kawung' });
            const [mpState, setMpState] = useState({ p1: { score: 0, grid: [], activeBlock: null, question: null, input: '', feedback: null, finished: false, lives: 5 }, p2: { score: 0, grid: [], activeBlock: null, question: null, input: '', feedback: null, finished: false, lives: 5 }, winner: null, timer: 0 });
            const [mpExplodingId, setMpExplodingId] = useState(null); 
            const timerRef = useRef(null);
            const [leaderboardData, setLeaderboardData] = useState([]);
            const [leaderboardFilter, setLeaderboardFilter] = useState({ province: 'Semua Provinsi', school: '', minLevel: 1, minScore: 0, sortBy: 'scoreDesc' });
            const [loginForm, setLoginForm] = useState({ name: '', province: PROVINCES[1], school: '' });

            useEffect(() => { 
                if (firebaseInitError) {
                    setAuthError(firebaseInitError);
                    setView('error');
                    return;
                }
                
                if(!auth) return;
                
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { 
                            await signInWithCustomToken(auth, __initial_auth_token); 
                        } else { 
                            await signInAnonymously(auth); 
                        }
                    } catch(err) {
                        console.error("Auth Init Error:", err);
                        if (err.code === 'auth/admin-restricted-operation') {
                            setAuthError("Fitur 'Anonymous Sign-in' belum diaktifkan di Firebase Console. Silakan buka Console > Authentication > Sign-in method > Aktifkan Anonymous.");
                        } else {
                            setAuthError(err.message);
                        }
                        setView('error');
                    }
                };
                initAuth();

                let unsubscribeProfile = null;

                const unsubscribeAuth = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    
                    if (unsubscribeProfile) {
                        unsubscribeProfile();
                        unsubscribeProfile = null;
                    }

                    if (u) {
                        const userRef = doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'main');
                        unsubscribeProfile = onSnapshot(userRef, (snap) => {
                            if (snap.exists()) { 
                                setUserData(snap.data()); 
                                setView(v => (v === 'loading' || v === 'landing' || v === 'login') ? 'menu' : v); 
                            } else { 
                                setView(v => v === 'loading' ? 'landing' : v); 
                            }
                        }, (error) => {
                            console.error("Snapshot error:", error);
                            // Fallback jika pembacaan database gagal, agar tidak stuck di loading
                            setUserData(null);
                            setView('landing'); 
                        });
                    } else {
                        setUserData(null);
                        setView('landing'); 
                    }
                });

                // Safety timeout: Jika dalam 10 detik masih loading, force ke landing (misal koneksi lambat)
                const safetyTimeout = setTimeout(() => {
                    setView(v => v === 'loading' ? 'landing' : v);
                }, 10000);

                return () => {
                    if (unsubscribeProfile) unsubscribeProfile();
                    unsubscribeAuth();
                    clearTimeout(safetyTimeout);
                };
            }, []);

            // ... (submitToGAS, fetchFromGAS, saveUserData, handleLogin, handleLogout - UNCHANGED) ...
            const submitToGAS = async (data) => { if (!GOOGLE_SCRIPT_URL) return; try { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); } catch (e) { console.error("GAS Submit Error:", e); } };
            const fetchFromGAS = async () => { if (!GOOGLE_SCRIPT_URL) return null; try { const response = await fetch(GOOGLE_SCRIPT_URL); return await response.json(); } catch (e) { console.error("GAS Fetch Error:", e); return null; } };
            const saveUserData = async (newData) => { if (!user) return; const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'); const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid); const finalData = { ...userData, ...newData, updatedAt: serverTimestamp() }; if (newData.maxLevel === undefined && finalData.maxLevel === undefined) finalData.maxLevel = 1; try { await setDoc(userRef, finalData, { merge: true }); await setDoc(publicRef, { uid: user.uid, name: finalData.name, school: finalData.school, province: finalData.province, points: finalData.points || 0, maxLevel: finalData.maxLevel || 1, rankTitle: getRank(finalData.points || 0).title }, { merge: true }); submitToGAS({ name: finalData.name, province: finalData.province, school: finalData.school, level: finalData.maxLevel || 1, points: finalData.points || 0, uid: user.uid }); setUserData(finalData); } catch (e) { console.error(e); } };
            const handleLogin = async (e) => { e.preventDefault(); if (!loginForm.name || !loginForm.school) return; const initData = { name: loginForm.name, province: loginForm.province, school: loginForm.school, points: 0, maxLevel: 1, ownedBatiks: ['kawung'], powerups: { bomb: 1, hint: 3 }, createdAt: serverTimestamp() }; 
                try {
                    await saveUserData(initData);
                    setView('menu'); 
                } catch(err) {
                     alert("Gagal menyimpan data ke database. Cek koneksi atau izin database Anda.");
                }
            };
            const handleLogout = async () => { if (auth) { await signOut(auth); } setUser(null); setUserData(null); setMpSetup({ p1Name: '', p2Name: '', level: 1, p1Skin: 'kawung', p2Skin: 'kawung' }); setLoginForm({ name: '', province: PROVINCES[1], school: '' }); setView('landing'); };

            // ... (Helpers and Game Logic - UNCHANGED) ...
            const generateQuestion = (level, isSpecial) => { if (isSpecial) { const n1 = Math.floor(Math.random() * 6) + 5; const n2 = Math.floor(Math.random() * 6) + 5; return { n1, n2, ans: n1 * n2 }; } let n1, n2; if (level <= 2) { n1 = Math.floor(Math.random() * 9) + 1; n2 = Math.floor(Math.random() * 9) + 1; } else if (level <= 5) { n1 = Math.floor(Math.random() * 90) + 10; n2 = Math.floor(Math.random() * 9) + 1; } else { n1 = Math.floor(Math.random() * 90) + 10; n2 = Math.floor(Math.random() * 90) + 10; } return { n1, n2, ans: n1 * n2 }; };
            const generateGridWithQuestions = (count, level) => { const indices = Array.from({ length: count }, (_, i) => i); for (let i = indices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [indices[i], indices[j]] = [indices[j], indices[i]]; } const specialIndices = new Set(indices.slice(0, 5)); return Array(count).fill(null).map((_, i) => { const isSpecial = specialIndices.has(i); return { id: i, active: true, isSpecial: isSpecial, q: generateQuestion(level, isSpecial) }; }); };
            const initSingleGame = (batikId) => { const batik = BATIKS.find(b => b.id === batikId); setActiveBatik(batik); setScore(0); setMoves(30); setLevel(1); setLives(5); setIsGameOver(false); setPowerups(userData?.powerups || { bomb: 1, hint: 3 }); const newGrid = generateGridWithQuestions(20, 1); setGrid(newGrid); setView('game'); };
            const handleBlockClick = (block) => { if (!block.active || moves <= 0 || isGameOver) return; setQuestion(block.q); setSelectedBlock(block); setInputAnswer(''); setFeedback(null); };
            const submitAnswer = () => { const val = parseInt(inputAnswer); if (val === question.ans) { setFeedback('correct'); playExplosionSound(); setExplodingBlockId(selectedBlock.id); setTimeout(() => { const newGrid = [...grid]; newGrid[selectedBlock.id].active = false; setGrid(newGrid); setExplodingBlockId(null); const multiplier = selectedBlock.isSpecial ? 2 : 1; const earned = activeBatik.baseScore * multiplier; setScore(s => s + earned); setMoves(m => m - 1); if (newGrid.filter(b => b.active).length === 0) handleWin(); setQuestion(null); }, 500); } else { playWrongSound(); setFeedback('wrong'); setLives(l => l - 1); setMoves(m => m - 1); if (activeBatik.penalty > 0) { setScore(s => Math.max(0, s - activeBatik.penalty)); } setTimeout(() => { setQuestion(null); if (lives <= 1) setIsGameOver(true); }, 800); } };
            
            const handleWin = () => {
                const bonus = moves * 50 + (lives * 100);
                const totalEarned = score + bonus;
                const newTotalPoints = (userData?.points || 0) + totalEarned;
                const newMaxLevel = Math.max(userData?.maxLevel || 1, level + 1);
                
                saveUserData({ points: newTotalPoints, maxLevel: newMaxLevel });
                
                if (level >= MAX_LEVEL_TO_WIN) {
                    alert(`LUAR BIASA! Kamu telah menamatkan semua level!\nSkor Akhir: ${score + bonus}`);
                    setView('menu');
                } else {
                    const nextLevel = level + 1;
                    if(confirm(`Hebat! Level ${level} Selesai.\nLanjut ke Level ${nextLevel}?`)) {
                        setLevel(nextLevel);
                        setMoves(30);
                        setGrid(generateGridWithQuestions(20, nextLevel));
                        setScore(0); 
                    } else {
                        setView('menu');
                    }
                }
            };

            const prepareMultiplayer = () => { if ((userData?.points || 0) <= 0) { alert("Maaf, kamu harus bermain Single Player setidaknya sekali dan mendapatkan poin untuk membuka fitur Multiplayer!"); return; } const firstOwned = userData?.ownedBatiks && userData.ownedBatiks.length > 0 ? userData.ownedBatiks[0] : 'kawung'; setMpSetup({ p1Name: userData?.name || '', p2Name: '', level: 1, p1Skin: firstOwned, p2Skin: firstOwned }); setView('multiplayer-setup'); }
            const startMultiplayer = () => { if (!mpSetup.p2Name) { alert("Masukkan nama Pemain 2!"); return; } let timeLimit = 600; if (mpSetup.level === 2) timeLimit = 480; if (mpSetup.level === 3) timeLimit = 300; const p1Grid = generateGridWithQuestions(20, mpSetup.level + 1); const p2Grid = generateGridWithQuestions(20, mpSetup.level + 1); const createInitialState = (gridData) => ({ score: 0, grid: gridData, activeBlock: null, question: null, input: '', feedback: null, finished: false, lives: 5 }); setMpState({ p1: createInitialState(p1Grid), p2: createInitialState(p2Grid), winner: null, timer: timeLimit }); setView('multiplayer-game'); };
            useEffect(() => { if (view === 'multiplayer-game' && !mpState.winner && mpState.timer > 0) { timerRef.current = setInterval(() => { setMpState(prev => { if (prev.timer <= 1) { clearInterval(timerRef.current); return { ...prev, timer: 0, winner: 'draw' }; } return { ...prev, timer: prev.timer - 1 }; }); }, 1000); } else if (mpState.winner || mpState.timer === 0) { clearInterval(timerRef.current); } return () => clearInterval(timerRef.current); }, [view, mpState.winner]);
            const handleMpBlockClick = (pk, block) => { if (!block.active || mpState.winner || mpState[pk].question) return; setMpState(prev => ({ ...prev, [pk]: { ...prev[pk], activeBlock: block, question: block.q, input: '', feedback: null } })); };
            const handleMpInput = (pk, val) => { if (mpState[pk].input.length < 5) setMpState(prev => ({ ...prev, [pk]: { ...prev[pk], input: prev[pk].input + val } })); };
            const handleMpDelete = (pk) => setMpState(prev => ({ ...prev, [pk]: { ...prev[pk], input: prev[pk].input.slice(0, -1) } }));
            const handleMpSubmit = (pk) => { const player = mpState[pk]; if (!player.question) return; const currentSkinId = pk === 'p1' ? mpSetup.p1Skin : mpSetup.p2Skin; const currentBatik = BATIKS.find(b => b.id === currentSkinId); if (parseInt(player.input) === player.question.ans) { playExplosionSound(); setMpExplodingId({ player: pk, id: player.activeBlock.id }); const newGrid = [...player.grid]; newGrid[player.activeBlock.id].active = false; const finished = newGrid.every(b => !b.active); const multiplier = player.activeBlock.isSpecial ? 2 : 1; const earned = currentBatik.baseScore * multiplier; const newScore = player.score + earned; setMpState(prev => { const next = { ...prev, [pk]: { ...prev[pk], grid: newGrid, score: newScore, feedback: 'correct', finished } }; if (finished && !prev.winner) next.winner = pk; return next; }); setTimeout(() => { setMpState(prev => ({ ...prev, [pk]: { ...prev[pk], question: null, activeBlock: null, feedback: null } })); setMpExplodingId(null); }, 500); } else { playWrongSound(); setMpState(prev => { const newLives = prev[pk].lives - 1; let newScore = prev[pk].score; if (currentBatik.penalty > 0) { newScore = Math.max(0, newScore - currentBatik.penalty); } const next = { ...prev, [pk]: { ...prev[pk], feedback: 'wrong', input: '', lives: newLives, score: newScore } }; if (newLives <= 0 && !prev.winner) { next.winner = pk === 'p1' ? 'p2' : 'p1'; } return next; }); } };
            const getRank = (pts) => RANKS.slice().reverse().find(r => pts >= r.min) || RANKS[0];
            const usePowerUp = (type) => { if (powerups[type] > 0) { if (type === 'hint') { if (!question) return; setInputAnswer(question.ans.toString()); } const newPowerups = { ...powerups, [type]: powerups[type] - 1 }; setPowerups(newPowerups); saveUserData({ powerups: newPowerups }); } };

            useEffect(() => { if (view === 'leaderboard' && user) { const q = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'); const unsub = onSnapshot(q, (snapshot) => { const rawData = snapshot.docs.map(d => d.data()); let filtered = rawData.filter(d => { const matchProv = leaderboardFilter.province === 'Semua Provinsi' || d.province === leaderboardFilter.province; const matchSchool = d.school?.toLowerCase().includes(leaderboardFilter.school.toLowerCase()); const matchLevel = (d.maxLevel || 1) >= parseInt(leaderboardFilter.minLevel); const matchScore = (d.points || 0) >= parseInt(leaderboardFilter.minScore); return matchProv && matchSchool && matchLevel && matchScore; }); filtered.sort((a, b) => leaderboardFilter.sortBy === 'scoreDesc' ? (b.points || 0) - (a.points || 0) : (a.points || 0) - (b.points || 0)); setLeaderboardData(filtered.slice(0, 100)); }); return () => unsub(); } }, [view, leaderboardFilter, user]);

            if (view === 'error') return React.createElement('div', { className: "min-h-dvh bg-red-50 flex flex-col items-center justify-center p-8 text-center" }, React.createElement('div', { className: "bg-white p-8 rounded-2xl shadow-xl max-w-lg" }, React.createElement(AlertTriangle, { size: 48, className: "text-red-500 mx-auto mb-4" }), React.createElement('h1', { className: "text-2xl font-bold text-red-900 mb-4" }, "Konfigurasi Firebase Hilang / Error"), React.createElement('p', { className: "text-red-700 mb-4" }, authError || "Game ini membutuhkan database Firebase untuk berjalan. Namun, konfigurasi tidak ditemukan."), React.createElement('button', { onClick: () => window.location.reload(), className: "bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700" }, "Muat Ulang")));
            if (view === 'loading') return React.createElement('div', { className: "min-h-dvh bg-amber-50 flex flex-col items-center justify-center p-4" }, React.createElement('div', { className: "animate-spin rounded-full h-12 w-12 border-b-2 border-amber-800 mb-4" }), React.createElement('h1', { className: "text-xl font-serif text-amber-900" }, "Memuat Batik Matika..."));
            if (view === 'landing') return React.createElement('div', { className: "min-h-dvh flex flex-col items-center justify-end p-8 relative overflow-hidden font-sans" }, React.createElement('div', { className: "absolute inset-0 z-0", style: { backgroundImage: "url('https://raw.githubusercontent.com/CikguTere/background.png/refs/heads/main/Desain%20tanpa%20judul%20(1).png')", backgroundSize: 'cover', backgroundPosition: 'top center', backgroundRepeat: 'no-repeat', opacity: 1 } }), React.createElement('div', { className: "relative z-10 w-full max-w-md mb-12" }, React.createElement('button', { onClick: () => setView('login'), className: "w-full py-4 bg-gradient-to-r from-amber-700 to-amber-900 text-white rounded-2xl font-bold text-xl shadow-2xl hover:shadow-amber-500/50 transform hover:-translate-y-1 transition-all flex items-center justify-center gap-3 border-2 border-amber-500 animate-bounce active:scale-95 touch-manipulation" }, React.createElement(Play, { fill: "white" }), "Mulai Petualangan")));
            if (view === 'login') return React.createElement('div', { className: "min-h-dvh bg-amber-50 flex flex-col items-center justify-center p-4 font-sans relative overflow-hidden" }, React.createElement('div', { className: "absolute top-4 left-4" }, React.createElement('button', { onClick: () => setView('landing'), className: "p-3 bg-white rounded-full shadow text-amber-900" }, React.createElement(ArrowLeft, null))), React.createElement('div', { className: "bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md z-10 border border-amber-200" }, React.createElement('div', { className: "text-center mb-6 md:mb-8" }, React.createElement('h1', { className: "text-2xl md:text-3xl font-bold text-amber-800 font-serif mb-2" }, "Identitas Pemain"), React.createElement('p', { className: "text-amber-600 text-xs md:text-sm" }, "Isi data diri untuk menyimpan skor")), React.createElement('form', { onSubmit: handleLogin, className: "space-y-4" }, React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Nama Lengkap"), React.createElement('div', { className: "relative" }, React.createElement(User, { className: "absolute left-3 top-3 w-5 h-5 text-gray-400" }), React.createElement('input', { required: true, type: "text", className: "w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none touch-manipulation", placeholder: "Isi namamu...", value: loginForm.name, onChange: e => setLoginForm({ ...loginForm, name: e.target.value }) }))), React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Provinsi"), React.createElement('div', { className: "relative" }, React.createElement(MapPin, { className: "absolute left-3 top-3 w-5 h-5 text-gray-400" }), React.createElement('select', { className: "w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none bg-white touch-manipulation", value: loginForm.province, onChange: e => setLoginForm({ ...loginForm, province: e.target.value }) }, PROVINCES.slice(1).map(p => React.createElement('option', { key: p, value: p }, p))))), React.createElement('div', null, React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Nama Sekolah"), React.createElement('div', { className: "relative" }, React.createElement(School, { className: "absolute left-3 top-3 w-5 h-5 text-gray-400" }), React.createElement('input', { required: true, type: "text", className: "w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none touch-manipulation", placeholder: "Contoh: SD Negeri 1 Jakarta", value: loginForm.school, onChange: e => setLoginForm({ ...loginForm, school: e.target.value }) }))), React.createElement('button', { type: "submit", className: "w-full bg-amber-700 text-white py-3 md:py-4 rounded-xl font-bold hover:bg-amber-800 transition-all shadow-lg mt-4 transform active:scale-95 touch-manipulation" }, "Lanjut Main"))));

            if (view === 'menu') {
                const rank = getRank(userData?.points || 0);
                return React.createElement('div', { className: "min-h-dvh bg-amber-50 p-4 font-sans flex flex-col max-w-lg md:max-w-2xl mx-auto" },
                    React.createElement('div', { className: "bg-gradient-to-r from-amber-700 to-amber-900 rounded-2xl p-6 text-white shadow-lg mb-6 relative overflow-hidden" },
                        React.createElement('div', { className: "absolute right-0 top-0 opacity-20 w-32 h-32" }, React.createElement(BatikPattern, { type: "clouds" })),
                        React.createElement('div', { className: "relative z-10" },
                            React.createElement('div', { className: "mb-4 text-amber-200 text-sm md:text-base font-medium flex items-center gap-2" }, React.createElement(User, { size: 16 }), " Selamat Datang, Pembatik Muda!"),
                            React.createElement('div', { className: "flex justify-between items-start" },
                                React.createElement('div', null, React.createElement('h2', { className: "text-2xl md:text-3xl font-bold" }, userData?.name), React.createElement('p', { className: "text-amber-200 text-sm md:text-base flex items-center gap-1" }, React.createElement(School, { size: 14 }), " ", userData?.school), React.createElement('p', { className: "text-amber-200 text-sm md:text-base flex items-center gap-1" }, React.createElement(MapPin, { size: 14 }), " ", userData?.province)),
                                React.createElement('div', { className: "text-right" }, React.createElement('p', { className: "text-3xl md:text-4xl font-bold" }, userData?.points?.toLocaleString()), React.createElement('p', { className: "text-xs md:text-sm uppercase tracking-wider text-amber-300" }, "Poin"))
                            ),
                            React.createElement('div', { className: "mt-4 pt-4 border-t border-amber-600/50 flex items-center justify-between" }, React.createElement('span', { className: "px-3 py-1 rounded-full bg-black/20 text-sm md:text-base font-medium border border-amber-400/30 flex items-center gap-2" }, React.createElement(Trophy, { size: 14, className: "text-yellow-400" }), " ", rank.title))
                        )
                    ),
                    React.createElement('div', { className: "grid grid-cols-2 gap-4 flex-1 content-start" },
                        React.createElement('button', { onClick: () => setView('skin-select'), className: "col-span-2 bg-white p-6 md:p-8 rounded-2xl shadow-md border-b-4 border-amber-600 active:scale-95 transition-transform flex flex-col items-center justify-center gap-3 hover:bg-amber-50 touch-manipulation" }, React.createElement('div', { className: "w-16 h-16 md:w-20 md:h-20 bg-amber-100 rounded-full flex items-center justify-center text-amber-700" }, React.createElement(User, { size: 32 })), React.createElement('span', { className: "font-bold text-xl md:text-2xl text-amber-900" }, "Single Player"), React.createElement('span', { className: "text-xs md:text-sm text-gray-500" }, "Petualangan Solo")),
                        React.createElement('button', { onClick: prepareMultiplayer, className: "col-span-2 bg-white p-6 md:p-8 rounded-2xl shadow-md border-b-4 border-blue-600 active:scale-95 transition-transform flex flex-col items-center justify-center gap-3 hover:bg-blue-50 touch-manipulation" }, React.createElement('div', { className: "w-16 h-16 md:w-20 md:h-20 bg-blue-100 rounded-full flex items-center justify-center text-blue-700" }, React.createElement(Users, { size: 32 })), React.createElement('span', { className: "font-bold text-xl md:text-2xl text-blue-900" }, "Multiplayer"), React.createElement('span', { className: "text-xs md:text-sm text-gray-500" }, "Mode Battle 1vs1")),
                        React.createElement('button', { onClick: () => setView('shop'), className: "bg-white p-4 md:p-6 rounded-2xl shadow-sm border-b-4 border-blue-600 active:scale-95 transition-transform flex flex-col items-center justify-center gap-2 touch-manipulation" }, React.createElement(ShoppingBag, { size: 24, className: "text-blue-600" }), React.createElement('span', { className: "font-bold text-base md:text-lg text-blue-900" }, "Toko Batik")),
                        React.createElement('button', { onClick: () => setView('leaderboard'), className: "bg-white p-4 md:p-6 rounded-2xl shadow-sm border-b-4 border-green-600 active:scale-95 transition-transform flex flex-col items-center justify-center gap-2 touch-manipulation" }, React.createElement(Trophy, { size: 24, className: "text-green-600" }), React.createElement('span', { className: "font-bold text-base md:text-lg text-green-900" }, "Peringkat")),
                    ),
                    React.createElement('div', { className: "mt-6" }, React.createElement('button', { onClick: handleLogout, className: "w-full py-3 md:py-4 border-2 border-red-200 text-red-600 rounded-xl font-bold hover:bg-red-50 flex items-center justify-center gap-2 touch-manipulation" }, React.createElement(LogOut, { size: 20 }), " Keluar / Ganti Akun"))
                );
            }

            if (view === 'multiplayer-select') return React.createElement('div', { className: "min-h-dvh bg-amber-50 p-4 flex flex-col justify-center items-center max-w-lg md:max-w-2xl mx-auto" }, React.createElement('h2', { className: "text-2xl md:text-3xl font-bold text-amber-900 mb-6 font-serif" }, "Pilih Mode Permainan"), React.createElement('div', { className: "w-full space-y-4" }, React.createElement('button', { onClick: () => setView('skin-select'), className: "w-full bg-white p-6 md:p-8 rounded-2xl shadow-md border-l-8 border-amber-600 flex items-center gap-4 hover:bg-amber-50 transition-all active:scale-95 touch-manipulation" }, React.createElement(User, { size: 32, className: "text-amber-700" }), React.createElement('div', { className: "text-left" }, React.createElement('h3', { className: "font-bold text-lg md:text-xl text-amber-900" }, "Single Player"), React.createElement('p', { className: "text-sm md:text-base text-gray-500" }, "20 Soal per level, 5 Nyawa."))), React.createElement('button', { onClick: prepareMultiplayer, className: "w-full bg-blue-50 p-6 md:p-8 rounded-2xl shadow-md border-l-8 border-blue-600 flex items-center gap-4 hover:bg-blue-100 transition-all active:scale-95 touch-manipulation" }, React.createElement(Users, { size: 32, className: "text-blue-700" }), React.createElement('div', { className: "text-left" }, React.createElement('h3', { className: "font-bold text-lg md:text-xl text-blue-900" }, "Multiplayer (Lokal)"), React.createElement('p', { className: "text-sm md:text-base text-gray-600" }, "Main berdua, Pilih Level & Skin.")))), React.createElement('button', { onClick: () => setView('menu'), className: "mt-8 text-amber-700 font-bold flex items-center gap-2 touch-manipulation" }, React.createElement(ArrowLeft, { size: 20 }), " Kembali"));
            if (view === 'skin-select') { 
                const ownedIds = userData?.ownedBatiks || [];
                const owned = BATIKS.filter(b => ownedIds.includes(b.id));
                if (owned.length === 0) owned.push(BATIKS[0]); 
                return React.createElement('div', { className: "min-h-dvh bg-amber-50 p-4 flex flex-col max-w-lg md:max-w-3xl mx-auto" }, React.createElement('div', { className: "flex items-center gap-4 mb-6" }, React.createElement('button', { onClick: () => setView('multiplayer-select'), className: "p-2 bg-white rounded-full shadow-sm" }, React.createElement(ArrowLeft, { size: 24, className: "text-amber-900" })), React.createElement('h2', { className: "text-2xl font-bold text-amber-900" }, "Pilih Batik")), React.createElement('p', { className: "mb-4 text-amber-700 text-sm md:text-base" }, "Pilih pola batik yang ingin kamu gunakan untuk bermain:"), React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-4 gap-4" }, owned.map(b => React.createElement('button', { key: b.id, onClick: () => initSingleGame(b.id), className: "bg-white p-4 rounded-xl shadow-sm border border-amber-100 hover:border-amber-400 active:scale-95 transition-all flex flex-col items-center gap-3 touch-manipulation" }, React.createElement('div', { className: "w-16 h-16 md:w-24 md:h-24 rounded-lg overflow-hidden border-2 border-gray-200" }, React.createElement(BatikPattern, { type: b.pattern })), React.createElement('span', { className: "font-bold text-gray-800 text-sm md:text-base" }, b.name))))); 
            }
            if (view === 'multiplayer-setup') { 
                const ownedIds = userData?.ownedBatiks || [];
                const owned = BATIKS.filter(b => ownedIds.includes(b.id));
                if (owned.length === 0) owned.push(BATIKS[0]); 
                return React.createElement('div', { className: "min-h-dvh bg-amber-50 p-4 flex flex-col max-w-lg md:max-w-2xl mx-auto" }, React.createElement('div', { className: "flex items-center gap-4 mb-6" }, React.createElement('button', { onClick: () => setView('multiplayer-select'), className: "p-2 bg-white rounded-full shadow-sm" }, React.createElement(ArrowLeft, { size: 24, className: "text-amber-900" })), React.createElement('h2', { className: "text-2xl font-bold text-amber-900" }, "Setup Multiplayer")), React.createElement('div', { className: "space-y-6 bg-white p-6 rounded-2xl shadow-md border border-amber-200" }, React.createElement('div', null, React.createElement('h3', { className: "font-bold text-lg text-amber-800 mb-2" }, "Pemain"), React.createElement('div', { className: "grid grid-cols-2 gap-4" }, React.createElement('div', null, React.createElement('label', { className: "text-xs font-bold text-gray-500 uppercase" }, "Pemain 1"), React.createElement('input', { type: "text", className: "w-full p-2 border rounded font-bold text-amber-900 touch-manipulation", value: mpSetup.p1Name, onChange: e => setMpSetup({ ...mpSetup, p1Name: e.target.value }) })), React.createElement('div', null, React.createElement('label', { className: "text-xs font-bold text-gray-500 uppercase" }, "Pemain 2"), React.createElement('input', { type: "text", placeholder: "Nama Lawan", className: "w-full p-2 border rounded font-bold text-blue-900 touch-manipulation", value: mpSetup.p2Name, onChange: e => setMpSetup({ ...mpSetup, p2Name: e.target.value }) })))), React.createElement('div', null, React.createElement('h3', { className: "font-bold text-lg text-amber-800 mb-2" }, "Pilih Level & Waktu"), React.createElement('div', { className: "flex gap-2" }, [1, 2, 3].map(lvl => { const times = ["10m", "8m", "5m"]; return React.createElement('button', { key: lvl, onClick: () => setMpSetup({ ...mpSetup, level: lvl }), className: `flex-1 py-3 rounded-xl border-2 flex flex-col items-center touch-manipulation ${mpSetup.level === lvl ? 'border-amber-600 bg-amber-50 text-amber-900' : 'border-gray-200 text-gray-400'}` }, React.createElement('span', { className: "font-bold text-lg" }, lvl), React.createElement('span', { className: "text-xs" }, times[lvl-1])); }))), React.createElement('div', null, React.createElement('h3', { className: "font-bold text-lg text-amber-800 mb-2" }, "Pilih Skin Batik"), React.createElement('div', { className: "grid grid-cols-2 gap-4" }, React.createElement('div', null, React.createElement('label', { className: "text-xs font-bold text-gray-500 block mb-1" }, "Skin P1"), React.createElement('select', { className: "w-full p-2 border rounded bg-white touch-manipulation", value: mpSetup.p1Skin, onChange: e => setMpSetup({ ...mpSetup, p1Skin: e.target.value }) }, owned.map(b => React.createElement('option', { key: b.id, value: b.id }, b.name)))), React.createElement('div', null, React.createElement('label', { className: "text-xs font-bold text-gray-500 block mb-1" }, "Skin P2"), React.createElement('select', { className: "w-full p-2 border rounded bg-white touch-manipulation", value: mpSetup.p2Skin, onChange: e => setMpSetup({ ...mpSetup, p2Skin: e.target.value }) }, owned.map(b => React.createElement('option', { key: b.id, value: b.id }, b.name)))))), React.createElement('button', { onClick: startMultiplayer, className: "w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg text-lg hover:bg-blue-700 active:scale-95 transition-all touch-manipulation" }, "Mulai Pertandingan"))); 
            }
            if (view === 'multiplayer-game') { const getBatikPattern = (id) => BATIKS.find(b => b.id === id)?.pattern || 'circles'; const formatTime = (s) => { const m = Math.floor(s / 60); const sec = s % 60; return `${m}:${sec < 10 ? '0' : ''}${sec}`; }; return React.createElement('div', { className: "h-dvh bg-slate-900 flex flex-row overflow-hidden font-sans relative" }, React.createElement('div', { className: "absolute top-0 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-1 rounded-b-xl font-mono font-bold border-x border-b border-slate-600 z-50 flex items-center gap-2 shadow-xl" }, React.createElement(Clock, { size: 16, className: mpState.timer < 60 ? "text-red-500 animate-pulse" : "text-white" }), React.createElement('span', { className: mpState.timer < 60 ? "text-red-500" : "" }, formatTime(mpState.timer))), React.createElement('div', { className: `flex-1 border-r-4 border-slate-700 relative p-1 md:p-2 flex flex-col items-center ${mpState.winner === 'p1' ? 'bg-amber-900/30' : ''}` }, React.createElement('div', { className: "w-full bg-slate-800 p-2 text-white flex justify-between rounded-lg mb-2 items-center" }, React.createElement('div', { className: "flex flex-col" }, React.createElement('span', { className: "font-bold text-amber-500 text-xs md:text-sm" }, mpSetup.p1Name || 'P1'), React.createElement('div', { className: "flex gap-0.5" }, [...Array(5)].map((_, i) => React.createElement(Heart, { key: i, size: 12, className: i < mpState.p1.lives ? "text-red-500" : "text-slate-600", fill: i < mpState.p1.lives ? "currentColor" : "none" })))), React.createElement('span', { className: "font-mono text-lg md:text-xl" }, mpState.p1.score)), React.createElement('div', { className: "relative w-full max-w-[400px] aspect-[5/4] rounded-lg overflow-hidden border-2 border-slate-600 mb-2 bg-slate-900/50" }, React.createElement('div', { className: "grid grid-cols-5 grid-rows-4 gap-0.5 w-full h-full" }, mpState.p1.grid.map(b => React.createElement(PuzzleBlock, { key: b.id, block: b, batikType: getBatikPattern(mpSetup.p1Skin), isExploding: mpExplodingId?.player === 'p1' && mpExplodingId?.id === b.id, onClick: () => handleMpBlockClick('p1', b) })))), React.createElement('div', { className: "flex-1 w-full bg-slate-800 rounded-lg p-1 flex flex-col justify-center overflow-hidden" }, mpState.p1.question ? React.createElement('div', { className: "text-center transform scale-90 md:scale-100" }, React.createElement('div', { className: "text-white text-lg md:text-xl font-mono mb-1" }, `${mpState.p1.question.n1} × ${mpState.p1.question.n2}`), React.createElement('div', { className: `h-8 bg-white rounded mb-1 text-lg font-bold flex items-center justify-center ${mpState.p1.feedback === 'wrong' ? 'text-red-600' : 'text-black'} ${mpState.p1.activeBlock?.isSpecial ? 'border-2 border-blue-500 text-blue-600 bg-blue-50' : ''}` }, mpState.p1.input), React.createElement(NumPad, { onInput: (v) => handleMpInput('p1', v), onDelete: () => handleMpDelete('p1'), onSubmit: () => handleMpSubmit('p1') })) : React.createElement('div', { className: "text-slate-500 text-center text-xs" }, "Pilih Blok")), mpState.winner === 'p1' && React.createElement('div', { className: "absolute inset-0 bg-black/60 flex items-center justify-center z-20" }, React.createElement('div', { className: "text-amber-400 text-2xl font-bold animate-bounce text-center" }, "MENANG!", React.createElement('div', { className: "text-sm text-white font-normal mt-2" }, "Lawan Kehabisan Nyawa/Waktu")))), React.createElement('div', { className: `flex-1 relative p-1 md:p-2 flex flex-col items-center ${mpState.winner === 'p2' ? 'bg-blue-900/30' : ''}` }, React.createElement('div', { className: "w-full bg-slate-800 p-2 text-white flex justify-between rounded-lg mb-2 items-center" }, React.createElement('div', { className: "flex flex-col" }, React.createElement('span', { className: "font-bold text-blue-500 text-xs md:text-sm" }, mpSetup.p2Name || 'P2'), React.createElement('div', { className: "flex gap-0.5" }, [...Array(5)].map((_, i) => React.createElement(Heart, { key: i, size: 12, className: i < mpState.p2.lives ? "text-red-500" : "text-slate-600", fill: i < mpState.p2.lives ? "currentColor" : "none" })))), React.createElement('span', { className: "font-mono text-lg md:text-xl" }, mpState.p2.score)), React.createElement('div', { className: "relative w-full max-w-[400px] aspect-[5/4] rounded-lg overflow-hidden border-2 border-slate-600 mb-2 bg-slate-900/50" }, React.createElement('div', { className: "grid grid-cols-5 grid-rows-4 gap-0.5 w-full h-full" }, mpState.p2.grid.map(b => React.createElement(PuzzleBlock, { key: b.id, block: b, batikType: getBatikPattern(mpSetup.p2Skin), onClick: () => handleMpBlockClick('p2', b) })))), React.createElement('div', { className: "flex-1 w-full bg-slate-800 rounded-lg p-1 flex flex-col justify-center overflow-hidden" }, mpState.p2.question ? React.createElement('div', { className: "text-center transform scale-90 md:scale-100" }, React.createElement('div', { className: "text-white text-lg md:text-xl font-mono mb-1" }, `${mpState.p2.question.n1} × ${mpState.p2.question.n2}`), React.createElement('div', { className: `h-8 bg-white rounded mb-1 text-lg font-bold flex items-center justify-center ${mpState.p2.feedback === 'wrong' ? 'text-red-600' : 'text-black'} ${mpState.p2.activeBlock?.isSpecial ? 'border-2 border-blue-500 text-blue-600 bg-blue-50' : ''}` }, mpState.p2.input), React.createElement(NumPad, { onInput: (v) => handleMpInput('p2', v), onDelete: () => handleMpDelete('p2'), onSubmit: () => handleMpSubmit('p2') })) : React.createElement('div', { className: "text-slate-500 text-center text-xs" }, "Pilih Blok")), mpState.winner === 'p2' && React.createElement('div', { className: "absolute inset-0 bg-black/60 flex items-center justify-center z-20" }, React.createElement('div', { className: "text-blue-400 text-2xl font-bold animate-bounce text-center" }, "MENANG!", React.createElement('div', { className: "text-sm text-white font-normal mt-2" }, "Lawan Kehabisan Nyawa/Waktu")))), mpState.winner === 'draw' && React.createElement('div', { className: "absolute inset-0 bg-black/80 flex items-center justify-center z-30" }, React.createElement('div', { className: "text-white text-3xl font-bold animate-pulse" }, "SERI! (Waktu Habis)")), React.createElement('div', { className: "absolute bottom-0 left-1/2 transform -translate-x-1/2 p-2 z-30" }, React.createElement('button', { onClick: () => setView('menu'), className: "bg-red-600 text-white px-4 py-1 rounded-full text-xs shadow-lg opacity-50 hover:opacity-100 touch-manipulation" }, "KELUAR"))); }
            if (view === 'leaderboard') return React.createElement('div', { className: "min-h-dvh bg-amber-50 p-4 max-w-lg md:max-w-2xl mx-auto flex flex-col" }, React.createElement('div', { className: "flex items-center gap-4 mb-4" }, React.createElement('button', { onClick: () => setView('menu'), className: "p-2 bg-white rounded-full shadow-sm" }, React.createElement(ArrowLeft, { size: 24, className: "text-amber-900" })), React.createElement('h2', { className: "text-2xl font-bold text-amber-900" }, "Papan Juara")), React.createElement('div', { className: "bg-white p-3 rounded-xl shadow-sm border border-amber-200 mb-4 space-y-2 text-sm" }, React.createElement('div', { className: "flex items-center gap-2 text-amber-900 font-bold mb-1" }, React.createElement(Filter, { size: 16 }), " Filter Leaderboard"), React.createElement('div', { className: "grid grid-cols-2 gap-2" }, React.createElement('select', { className: "p-2 border rounded bg-gray-50 w-full", value: leaderboardFilter.province, onChange: (e) => setLeaderboardFilter({...leaderboardFilter, province: e.target.value}) }, PROVINCES.map(p => React.createElement('option', { key: p, value: p }, p))), React.createElement('input', { type: "text", placeholder: "Cari Sekolah...", className: "p-2 border rounded bg-gray-50 w-full", value: leaderboardFilter.school, onChange: (e) => setLeaderboardFilter({...leaderboardFilter, school: e.target.value}) })), React.createElement('div', { className: "grid grid-cols-2 gap-2" }, React.createElement('div', { className: "flex items-center gap-2" }, React.createElement('span', { className: "text-xs text-gray-500" }, "Min Level:"), React.createElement('input', { type: "number", min: 1, className: "p-1 border rounded bg-gray-50 w-16", value: leaderboardFilter.minLevel, onChange: (e) => setLeaderboardFilter({...leaderboardFilter, minLevel: e.target.value}) })), React.createElement('select', { className: "p-2 border rounded bg-gray-50 w-full", value: leaderboardFilter.sortBy, onChange: (e) => setLeaderboardFilter({...leaderboardFilter, sortBy: e.target.value}) }, React.createElement('option', { value: "scoreDesc" }, "Skor Tertinggi"), React.createElement('option', { value: "scoreAsc" }, "Skor Terendah")))), React.createElement('div', { className: "bg-white rounded-2xl shadow-sm border border-amber-100 overflow-hidden flex-1" }, React.createElement('table', { className: "w-full text-xs" }, React.createElement('thead', { className: "bg-amber-50 text-amber-900" }, React.createElement('tr', null, React.createElement('th', { className: "p-3 text-left w-8" }, "#"), React.createElement('th', { className: "p-3 text-left" }, "Nama & Sekolah"), React.createElement('th', { className: "p-3 text-center" }, "Level"), React.createElement('th', { className: "p-3 text-right" }, "Poin"))), React.createElement('tbody', null, leaderboardData.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 4, className: "p-8 text-center text-gray-400" }, "Tidak ada data yang cocok.")) : leaderboardData.map((d, i) => React.createElement('tr', { key: i, className: `border-b border-gray-100 ${d.uid === user?.uid ? 'bg-yellow-50' : ''}` }, React.createElement('td', { className: "p-3 font-bold text-gray-500" }, i + 1), React.createElement('td', { className: "p-3" }, React.createElement('div', { className: "font-bold text-gray-800" }, d.name), React.createElement('div', { className: "text-xs text-gray-500" }, d.school), React.createElement('div', { className: "text-[10px] text-amber-600 truncate max-w-[100px]" }, d.province)), React.createElement('td', { className: "p-3 text-center font-bold text-slate-600" }, d.maxLevel || 1), React.createElement('td', { className: "p-3 text-right font-mono font-bold text-amber-700" }, d.points?.toLocaleString())))))));
            if (view === 'shop') return React.createElement('div', { className: "min-h-dvh bg-amber-50 p-4 max-w-lg md:max-w-2xl mx-auto" }, React.createElement('div', { className: "flex items-center gap-4 mb-6" }, React.createElement('button', { onClick: () => setView('menu'), className: "p-2 bg-white rounded-full shadow-sm" }, React.createElement(ArrowLeft, { size: 24, className: "text-amber-900" })), React.createElement('h2', { className: "text-2xl font-bold text-amber-900" }, "Galeri Batik")), React.createElement('div', { className: "bg-amber-100 p-4 rounded-xl mb-6 flex justify-between items-center text-amber-900" }, React.createElement('span', { className: "font-medium" }, "Poin Kamu"), React.createElement('span', { className: "font-bold text-xl" }, userData?.points?.toLocaleString())), React.createElement('div', { className: "space-y-4" }, BATIKS.map(b => { const isOwned = userData?.ownedBatiks?.includes(b.id); return React.createElement('div', { key: b.id, className: "bg-white p-4 rounded-xl shadow-sm border border-amber-100 flex flex-col gap-2" }, React.createElement('div', { className: "flex items-center gap-4" }, React.createElement('div', { className: `w-16 h-16 rounded-lg overflow-hidden border-2 flex-shrink-0 ${isOwned ? 'border-green-500' : 'border-gray-300'}` }, React.createElement(BatikPattern, { type: b.pattern })), React.createElement('div', { className: "flex-1" }, React.createElement('h3', { className: "font-bold text-gray-800" }, b.name), React.createElement('p', { className: "text-xs text-gray-500" }, isOwned ? 'Sudah Dimiliki' : `${b.price} Poin`)), isOwned ? React.createElement('div', { className: "bg-green-100 text-green-700 px-3 py-1 rounded-lg font-bold text-xs" }, "Milikmu") : React.createElement('button', { onClick: () => { if ((userData?.points || 0) >= b.price) { const newPoints = (userData?.points || 0) - b.price; const newOwned = [...(userData?.ownedBatiks || []), b.id]; saveUserData({ points: newPoints, ownedBatiks: newOwned }); } }, disabled: (userData?.points || 0) < b.price, className: `px-3 py-1 rounded-lg font-bold text-xs flex items-center gap-1 ${(userData?.points || 0) >= b.price ? 'bg-amber-600 text-white shadow-md active:scale-95' : 'bg-gray-200 text-gray-400'}` }, React.createElement(Lock, { size: 12 }), " Beli")), React.createElement('div', { className: "bg-slate-50 p-2 rounded text-xs text-slate-600 italic border-l-2 border-slate-300" }, "💡 ", b.mathConcept), React.createElement('div', { className: "bg-yellow-50 p-2 rounded text-xs text-yellow-800 border-l-2 border-yellow-400 mt-1" }, "⚡ ", b.ruleDesc)); })));
            if (view === 'game') {
                return React.createElement('div', { className: "min-h-dvh bg-slate-900 flex flex-col max-w-lg md:max-w-2xl mx-auto relative overflow-hidden font-sans" },
                    React.createElement('div', { className: "bg-slate-800 border-b border-slate-700 py-2 px-4 flex justify-between items-center text-xs text-slate-300" },
                        React.createElement('div', { className: "flex items-center gap-2 font-bold text-amber-400" }, React.createElement(User, { size: 14 }), React.createElement('span', null, userData?.name)),
                        React.createElement('div', { className: "flex items-center gap-1 opacity-70" }, React.createElement(School, { size: 14 }), React.createElement('span', { className: "truncate max-w-[120px]" }, userData?.school))
                    ),
                    React.createElement('div', { className: "bg-slate-800 p-4 text-white flex justify-between items-center shadow-lg z-10" },
                        React.createElement('div', { className: "flex flex-col" }, React.createElement('span', { className: "text-xs text-slate-400" }, "SKOR"), React.createElement('span', { className: "font-bold text-xl text-amber-400" }, score)),
                        React.createElement('div', { className: "flex gap-1 bg-slate-700 px-3 py-1 rounded-full" }, [...Array(5)].map((_, i) => React.createElement(Heart, { key: i, size: 20, className: i < lives ? "text-red-500" : "text-slate-500", fill: i < lives ? "#ef4444" : "none" }))),
                        React.createElement('div', { className: "flex flex-col items-end" }, React.createElement('span', { className: "text-xs text-slate-400" }, "LANGKAH"), React.createElement('span', { className: `font-bold text-xl ${moves < 5 ? 'text-red-500 animate-pulse' : 'text-white'}` }, moves))
                    ),
                    React.createElement('div', { className: "flex-1 relative flex items-center justify-center p-4" },
                        React.createElement('div', { className: "relative w-full aspect-[5/4] max-w-md md:max-w-xl rounded-xl p-1 bg-slate-900/50" },
                             React.createElement('div', { className: "grid grid-cols-5 grid-rows-4 gap-1 w-full h-full" },
                                grid.map(block => React.createElement(PuzzleBlock, {
                                    key: block.id,
                                    block: block,
                                    batikType: activeBatik.pattern,
                                    isExploding: explodingBlockId === block.id,
                                    onClick: () => handleBlockClick(block)
                                }))
                             )
                        )
                    ),
                    React.createElement('div', { className: "px-4 pb-2 text-center text-slate-400 text-xs md:text-sm italic" }, `Pola: ${activeBatik.name} — ${activeBatik.mathConcept}`),
                    React.createElement('div', { className: "p-4 flex justify-between items-center bg-slate-800 pb-8" },
                        React.createElement('button', { onClick: () => setView('menu'), className: "p-3 rounded-full bg-slate-700 text-slate-300" }, React.createElement(ArrowLeft, null)),
                        React.createElement('div', { className: "flex gap-4" },
                            React.createElement('button', { disabled: true, className: "relative p-3 bg-blue-600 rounded-xl text-white shadow-lg flex flex-col items-center w-16 opacity-80" }, React.createElement(Zap, { size: 20 }), React.createElement('span', { className: "text-[10px] mt-1" }, "Hint"), React.createElement('span', { className: "absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center border-2 border-slate-800" }, powerups.hint))
                        )
                    ),
                    question && !isGameOver && React.createElement('div', { className: "absolute inset-0 z-40 bg-black/80 backdrop-blur-sm flex flex-col justify-end" },
                        React.createElement('div', { className: "bg-white rounded-t-3xl p-6 animate-slide-up pb-10 max-w-lg md:max-w-xl mx-auto w-full" },
                            React.createElement('div', { className: "text-center mb-6" }, React.createElement('h3', { className: "text-gray-500 text-sm uppercase tracking-widest mb-2" }, "Pecahkan Kode"), React.createElement('div', { className: "text-5xl font-bold text-amber-900 font-mono tracking-tighter" }, `${question.n1} × ${question.n2} = ?`)),
                            React.createElement('div', { className: `w-full bg-gray-100 p-4 rounded-xl text-center text-3xl font-bold mb-4 border-2 ${feedback === 'correct' ? 'border-green-500 text-green-600' : feedback === 'wrong' ? 'border-red-500 text-red-600' : 'border-gray-300 text-gray-800'} ${selectedBlock?.isSpecial ? 'border-blue-500 bg-blue-50' : ''}` }, inputAnswer || "_", feedback === 'correct' && React.createElement(CheckCircle, { className: "inline ml-2" }), feedback === 'wrong' && React.createElement(XCircle, { className: "inline ml-2" })),
                            React.createElement(NumPad, { onInput: (n) => { if (inputAnswer.length < 5) setInputAnswer(prev => prev + n) }, onDelete: () => setInputAnswer(prev => prev.slice(0, -1)), onSubmit: submitAnswer })
                        )
                    ),
                    isGameOver && React.createElement('div', { className: "absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center p-6 text-center animate-fade-in" },
                        React.createElement('div', { className: "bg-slate-800 p-8 rounded-3xl border-2 border-red-500 shadow-2xl max-w-sm w-full" },
                            React.createElement('div', { className: "w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4" }, React.createElement(AlertTriangle, { size: 40, className: "text-red-600" })),
                            React.createElement('h2', { className: "text-3xl font-bold text-white mb-2" }, "Yah, Kalah!"),
                            React.createElement('p', { className: "text-slate-300 mb-6" }, "Nyawa kamu habis. Jangan menyerah, ayo coba lagi!"),
                            React.createElement('div', { className: "space-y-3" },
                                React.createElement('button', { onClick: () => initSingleGame(activeBatik.id), className: "w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 touch-manipulation" }, React.createElement(RefreshCw, { size: 20 }), " Ulangi Level"),
                                React.createElement('button', { onClick: () => setView('menu'), className: "w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold" }, "Kembali ke Menu")
                            )
                        )
                    )
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
